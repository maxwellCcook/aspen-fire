---
title: "aspen-fire_frp"
output: html_document
date: "2023-05-01"
---

## Aspen Controls on Satellite-derived Fire Radiative Power (FRP)

Setup the data frame and workspace:

```{r setup}

knitr::opts_chunk$set(echo = TRUE)

# LIBRARIES AND GLOBAL VARS
library(tidyverse)
library(sf)
library(ggpubr)
library(classInt)
library(ggcorrplot)
library(rstatix)
library(gt)

getwd()

proj <- st_crs("ESRI:102039")

# DATA

frp <- st_read('../../data/spatial/mod/VIIRS/fire_archive_SV-C2_srme_19to21_plots_w_attr.gpkg') %>%
 # tidy the frame
 mutate(DAYNIGHT = as.factor(DAYNIGHT)) %>%
 rename(Aspen = Aspen_S2,
        MixedConifer = Conifer_Hardwood) %>%
 filter(ACQ_YEAR <= 2020) %>%
 # Convert back to centroid (points) and ensure correct project
 st_centroid() %>% st_transform(proj)
mtbs <- st_read('../../data/spatial/mod/MTBS/mtbs_perims_srme_2019to2021_wAspen.gpkg')
srme <- st_read('../../data/spatial/mod/boundaries/na_cec_eco_l3_srme.gpkg')

gc() # garbage clean

```

```{r}
glimpse(frp)
```

## Data exploration and figures

Distribution of FRP Observations:

```{r message=F, warning=F}

p1 <- ggplot(data=frp, aes(x=FRP)) +
  geom_histogram(bins=30)  +
  labs(y="Count",x="frp") +
  theme_minimal(5) +
  theme(axis.text = element_text(size=7),
        axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5))
p2 <- p1 +
  scale_x_continuous(trans="sqrt") +
  labs(x="sqrt(frp)",y="")
p3 <- p1 +
  scale_x_continuous(trans="log10") +
  labs(x="log(frp)",y="")

arr <- ggarrange(p1,p2,p3,nrow=1,ncol=3)
arr

ggsave(arr,file="../../figures/frp/frp_distributions.png",dpi=150)
rm(p1,p2,p3,arr)

```

Distribution of aspen percentage:

```{r message=F}

df <- frp %>% 
 mutate(Aspen = if_else(Aspen == 0, 0.001, Aspen))
p1 <- ggplot(data=df, aes(x=Aspen)) +
  geom_histogram(bins=30)  +
  labs(y="Count",x="Aspen % of Obs.") +
  theme_minimal(5) +
  theme(axis.text = element_text(size=7),
        axis.text.x = element_text(size=5),
        axis.text.y = element_text(size=5))
p2 <- p1 +
  scale_x_continuous(trans="sqrt") +
  labs(x="sqrt(Aspen % of Obs.)",y="")
p3 <- p1 +
  scale_x_continuous(trans="log10") +
  labs(x="log(Aspen % of Obs.)",y="")
arr <- ggarrange(p1,p2,p3,nrow=1,ncol=3)
arr

ggsave(arr,file="../../figures/frp/frp_aspen_distributions.png",dpi=150)
rm(p1,p2,p3,arr,df)

```

Get a count of observations by fire:

```{r}
groups <- frp %>% 
 filter(CONFIDENCE=='h') %>% # only take high confidence
 group_by(Event_ID) %>% 
 summarize(total_obs = n()) %>%
 ungroup() %>%
 filter(total_obs >= 10)

frp <- frp %>% filter(Event_ID %in% groups$Event_ID)
mtbs <- mtbs %>% filter(Event_ID %in% groups$Event_ID)

rm(groups)
```

Spatial map of wildfires which burned through at least 5% aspen cover in the SRME (2019-2021):

```{r warning=F}
# Spatial map of wildfire perimeter which burned >= 5% aspen forest
ggplot() +
 geom_sf(data=srme,fill=NA) +
 geom_sf(data=mtbs%>%st_centroid(), aes(size=BurnBndAc, color=BurnBndAc)) +
 viridis::scale_color_viridis(option="magma",trans="log10") +
 # geom_sf_text(data = mtbs%>%st_centroid(), aes(label = Incid_Name)) + 
 theme_void(12)
```

Observations of FRP:

```{r message=F}

p1 <- ggplot(data=frp, aes(x=cut(ACQ_DATE, breaks="1 month"), y=FRP, fill=factor(DAYNIGHT))) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=c("#ef8a62","#999999"), labels=c("Daytime Obs.","Nighttime Obs.")) +
  labs(x="Acquisition Date", y="frp (gW)", fill="") +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
p1

ggsave(p1,file="../../figures/frp/frp_time-series_boxplot.png",dpi=150)

rm(p1)

```

Plotting aspen / no-aspen and frp across time:

```{r message=F}

brks <- classIntervals(frp$Aspen, style='headtails')
brks <- brks$brks

df <- frp %>% 
 mutate(Aspen_qt = factor(cut(Aspen, breaks=brks)),
        Aspen_qt = if_else(is.na(Aspen_qt), factor(0), Aspen_qt),
        Conifer_qt = factor(cut(Conifer, quantile(Conifer), include.lowest=TRUE, labels=FALSE)),
        ForestedPct = Conifer + Hardwood + MixedConifer,
        AspenNoAspen = factor(if_else(Aspen > 10, 1, 0))) %>%
 filter(ForestedPct > 50)

# Plots

p1 <- ggplot(data=df, aes(x=cut(ACQ_DATE, breaks="2 week"), y=FRP, fill=AspenNoAspen)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=c("#999999","#238443"), labels=c("No Aspen","Aspen")) +
  labs(x="Acquisition Date", y="frp (gW)", fill="Aspen Presence:") +
  facet_wrap(~DAYNIGHT, nrow=2) +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
p1

p2 <- ggplot(data=df, aes(x=factor(Incid_Name), y=FRP, fill=AspenNoAspen)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=c("#999999","#238443"), labels=c("No Aspen","Aspen")) +
  labs(x="Incident", y="frp (gW)", fill="Aspen Presence:") +
  facet_wrap(~DAYNIGHT, nrow=2) +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
p2

# ggsave(p,file="../../figures/frp/frp_AspenNoAspen_boxplot.png",dpi=300)
 
rm(p1,p2)

```

Produce the same plots but using the quantiles:

```{r message=F}

cols <- c('#ffffcc','#c2e699','#78c679','#238443','#005824')

p1 <- ggplot(data=df, aes(x=cut(ACQ_DATE, breaks="2 week"), y=FRP, fill=Aspen_qt)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=cols, 
                    labels=c("None","(0-6.96)","(6.96-28.24)","(28.24-54.69)","(54.69-99.24)")) +
  labs(x="Acquisition Date", y="frp (gW)", fill="Aspen Component (%):") +
  facet_wrap(~DAYNIGHT, nrow=2) +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
p1

p2 <- ggplot(data=df, aes(x=factor(Incid_Name), y=FRP, fill=Aspen_qt)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=cols, 
                    labels=c("None","(0-6.96)","(6.96-28.24)","(28.24-54.69)","(54.69-99.24)")) +
  labs(x="Incident", y="frp (gW)", fill="Aspen Component (%):") +
  facet_wrap(~DAYNIGHT, nrow=2) +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
p2

ggsave(p1,file="../../figures/frp/FRP-Aspen_Quantile_byWeek.png",dpi=300)
ggsave(p2,file="../../figures/frp/FRP-Aspen_Quantile_byFire.png",dpi=300)
 
rm(p1,p2)
```

Just the 2020 fires (for FBTB)

```{r}
df_ <- df %>%
 filter(Incid_Name == "EAST TROUBLESOME") %>%
 filter(DAYNIGHT == "D")

p <- ggplot(data=df_, aes(x=factor(Incid_Name), y=FRP, fill=Aspen_qt)) +
  geom_boxplot(outlier.size = 0.8) +
  scale_y_continuous(trans="log10") +
  scale_fill_manual(values=cols, 
                    labels=c("None","0-7%","7-28%","28-54%","54-99%")) +
  labs(x="Incident", y="Fire Radiative Power (gW)", fill="Aspen\nComponent:") +
  # facet_wrap(~DAYNIGHT, nrow=2) +
  theme_bw(10) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "right")
p

library(mgcv,quietly=T)
library(tidymv,quietly=T)
ctrl <- mgcv::gam.control(nthreads = 6) # use 6 parallel threads, reduce if fewer physical CPU cores
# Run a GAM
gamfit1 <- 
  mgcv::gam(log(FRP) ~ s(Aspen, k=15),
  method="REML",
  gamma=1.2,
  data=df_, 
  control=ctrl
)
# Plot the smooths
plot_smooths(gamfit1, Aspen) +
 theme(legend.position = "right") +
 labs(x="Aspen %") +
 theme_bw(14)

ggsave(p,file="../../figures/frp/FRP-Aspen_Quantile_byFire_co2020.png",dpi=300,width=3.5, height=3.75)
```

Statistical tests for significance between groups / aspen percent more broadly:

```{r message=F, warning=F}
# Summary stats
table <- df %>%
 select(Aspen_qt, FRP) %>%
 st_set_geometry(NULL) %>% as_tibble() %>%
 group_by(Aspen_qt) %>%
 get_summary_stats(FRP, type = "mean_sd") %>%
 rename(Aspen_Pct = Aspen_qt,
        N = n,
        Mean = mean,
        StDev = sd) %>%
 select(Aspen_Pct, N, Mean, StDev) %>%
 gt() %>%
 tab_header(title = "FRP ~ Aspen %") %>%
 tab_style(
  style = list(cell_fill(color = "#b2f7ef"),
  cell_text(weight = "bold")),
  locations = cells_body(columns = Mean))
table

# gtsave(table, "../../figures/frp/Table_FRP_AspenPct_Summary.png")

rm(table)
```

```{r warning=F, message=F}
# ANOVA test of significance
aspen.anova <- anova(lm(log(FRP) ~ Aspen_qt, data = df))
aspen.anova
# gtsave(aspen.anova %>%
#         gt() %>%
#         tab_header(title = "Analysis of variance (ANOVA)"),
#        "../../figures/frp/Table_FRP_AspenPct_Anova.png")

# Run a GAM to get an estimate of the effects for each group
glm.fit <- glm(log(FRP) ~ Aspen_qt, data = df)
summary(glm.fit)
sjPlot::tab_model(glm.fit)

# Create the effects plot
p <- sjPlot::plot_model(glm.fit, show.values = TRUE, value.offset = .3) + 
 labs(y="Model Estimate",x="Aspen Component",title="FRP ~ Aspen Component (%)") +
 scale_x_discrete(labels=c("Aspen_qt(0,6.87]" = "0-6.9%", "Aspen_qt(6.87,28]" = "6.9-28%", 
                           "Aspen_qt(28,54.6]" = "28-54.6%", "Aspen_qt(54.6,99.2]" = "54.6-99.2%")) +
 theme_bw(12) +
 theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       axis.text.y = element_text(angle=30,hjust = 1))
p
ggsave(p,file="../../figures/frp/FRP-Aspen_Quantile_GLM_estimates.png",dpi=120,height=5,width=4)
rm(p,glm.fit,aspen.anov)
```

```{r message=F}

p1 <- ggplot(data=df%>%filter(CONFIDENCE=='h'), aes(x=Aspen_qt, y=FRP, fill=DAYNIGHT)) +
 geom_boxplot(outlier.size = 0.8) +
 scale_y_continuous(trans="log10") +
 scale_fill_manual(values=c("#ef8a62","#999999"), labels=c("Daytime Obs.","Nighttime Obs.")) +
 labs(y="log(FRP)",x="Aspen Component") +
 theme_bw(10) +
 theme(legend.position = "top")
p1

ggsave(p1,file="../../figures/frp/FRP_Aspen_Breaks_boxplot.png",dpi=150)

rm(p1)

```

Plot of FRP across major cover types:

```{r message=F}
# LANDFIRE table
codes <- read_csv("../../../../data/landcover/LANDFIRE/LF2016_EVT_200_CONUS/CSV_Data/LF16_EVT_200.csv") %>%
 mutate(lfevt = factor(VALUE)) %>%
 select(lfevt,EVT_PHYS,EVT_GP_N)
# Majority type
lfevt <- read_csv("../../data/tabular/mod/LFEVT16/vnp14img_lf_evt_majority.csv") %>%
 mutate(lfevt = factor(lfevt_majority)) %>%
 select(uid,lfevt) %>%
 left_join(codes,by="lfevt")

# Join back to FRP data
df <- df %>% left_join(lfevt, by="uid")

summary(lfevt$lfevt)
glimpse(df)

rm(codes,lfevt)
```


```{r, message=F}
# Filter to LFEVT codes with > 100 observations
df.c <- df %>%
  na.omit() %>%
  group_by(lfevt) %>%
  filter(n() > 100)

# Plot groups
ggplot(data=df.c, aes(x=EVT_GP_N, y=FRP)) +
 geom_boxplot() +
 scale_y_continuous(trans="log10") +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
```

```{r}
df.c <- df %>%
 st_set_geometry(NULL) %>% as_tibble() %>%
 mutate(
  Dominant = if_else(Conifer == 100 & Aspen < 25, "Conifer", NA),
  Dominant = if_else(Aspen > 75, "Aspen", Dominant),
  Dominant = factor(Dominant)
 )
head(df.c,10)
summary(df.c$Dominant)
# Plot groups
ggplot(data=df.c %>% filter(Dominant=="Aspen"|Dominant=="Conifer"), aes(x=Dominant, y=FRP)) +
 geom_boxplot() +
 scale_y_continuous(trans="log10") +
  theme_bw(10) +
  theme(axis.text.x = element_text(angle=35,hjust = 1),
        legend.position = "top")
```

Statistical test:

```{r}
temp <- df.c %>% filter(Dominant=="Aspen"|Dominant=="Conifer")

# Anova test
aspen.anov <- anova(lm(log(FRP) ~ Dominant, data = temp))
aspen.anov

# Run a GLM to get an estimate of the effects for each group
glm.fit <- glm(log(FRP) ~ Dominant, data = temp)
summary(glm.fit)
exp(glm.fit$coefficients)
sjPlot::tab_model(glm.fit)
rm(temp)
```

GAM of Aspen percent:

```{r}
library(mgcv,quietly=T)
library(tidymv,quietly=T)
ctrl <- mgcv::gam.control(nthreads = 6) # use 6 parallel threads, reduce if fewer physical CPU cores
df <- df %>% mutate(Event_ID = factor(Event_ID))
# Run a GAM
gamfit1 <- 
  mgcv::gam(log(FRP) ~ s(Aspen, k=15),
  method="REML",
  gamma=1.2,
  data=df, 
  control=ctrl
)
###Check the model summaries (including k.check) and anova
summary(gamfit1) #Standard model summary
print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~GAM-Check~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
gam.check(gamfit1) #Check the basis dimension choice for smooths (k)
print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ANOVA~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
anova.gam(gamfit1) #anova for approximate significant of smooth terms
# Plot the smooths
plot_smooths(gamfit1, Aspen) +
 theme(legend.position = "top") +
 labs(x="Aspen %") +
 theme_bw(14)
```

